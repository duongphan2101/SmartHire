server {
listen 80;
server_name localhost;

root /usr/share/nginx/html;
index index.html;

# ============================
# 1) FRONTEND (Vite / React)
# ============================
location / {
    proxy_pass http://web:5173;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ============================
# 2) AUTH SERVICE
# ============================
location /api/auth/ {
    # KHÔNG REWRITE: Giữ nguyên /api/auth/... để backend nhận diện đúng
    proxy_pass http://auth-service:1111;
    proxy_set_header Host $host;
}

# ============================
# 3) USER SERVICE
# ============================
location /api/users/ {
    proxy_pass http://user-service:2222;
    proxy_set_header Host $host;
}

location /api/terms/ {
    proxy_pass http://user-service:2222;
    proxy_set_header Host $host;
}

# Route cho CVs (Nếu nằm trong User Service và Frontend gọi /api/cvs)
location /api/cvs/ {
    proxy_pass http://user-service:2222;
    proxy_set_header Host $host;
}

# ============================
# 4) COMMUNICATION SERVICE
# ============================
location /api/interviews/ {
    proxy_pass http://communication-service:1000;
    proxy_set_header Host $host;
}
location /api/chat/ {
    proxy_pass http://communication-service:1000;
    proxy_set_header Host $host;
}

# ============================
# 5) CHATBOT SERVICE
# ============================
location /api/chatbot/ {
    proxy_pass http://chatbot-service:3333;
    proxy_set_header Host $host;
}

# ============================
# 6) POST SERVICE (Jobs, Departments, Reviews, Reports)
# ============================
# Frontend gọi /api/jobs, /api/departments... -> Post Service nhận y hệt
location /api/jobs/ {
    proxy_pass http://post-service:4444;
    proxy_set_header Host $host;
}
location /api/departments/ {
    proxy_pass http://post-service:4444;
    proxy_set_header Host $host;
}
location /api/reviews/ {
    proxy_pass http://post-service:4444;
    proxy_set_header Host $host;
}
location /api/reports/ {
    proxy_pass http://post-service:4444;
    proxy_set_header Host $host;
}

# ============================
# 7) APPLICATION SERVICE
# ============================
location /api/applications/ {
    proxy_pass http://application-service:5555;
    proxy_set_header Host $host;
}

# ============================
# 8) MATCHING SERVICE
# ============================
location /api/matching/ {
    proxy_pass http://matching-service:6789;
    proxy_set_header Host $host;
}

# ============================
# 9) NOTIFICATION SERVICE
# ============================
location /api/notifications/ {
    proxy_pass http://notification-service:7000;
    proxy_set_header Host $host;
}

# ============================
# 10) PAYMENT SERVICE
# ============================
location /api/payment/ {
    # Lưu ý: Nếu Host BE ghi /api/payment (số ít) nhưng FE gọi số nhiều, cần rewrite
    #rewrite ^/api/payments/(.*)$ /api/payment/$1 break; 
    proxy_pass http://payment-service:7777;
    proxy_set_header Host $host;
}

location /api/wallet/ {
    proxy_pass http://payment-service:7777;
    proxy_set_header Host $host;
}

# ============================
# 11) CV AI SERVICE
# ============================
location /api/cvai/ {
    # rewrite ^/api/cvai/(.*)$ /$1 break;
    proxy_pass http://cv-ai-service:8080;
    proxy_set_header Host $host;
}

# ============================
# 12) EMAIL SERVICE
# ============================
location /api/email/ {
    proxy_pass http://email-service:5000;
    proxy_set_header Host $host;
}

location /api/forgot-password/ {
    proxy_pass http://email-service:5000;
    proxy_set_header Host $host;
}

# ============================
# 13) WEBSOCKET (SOCKET.IO)
# ============================
location /socket.io/ {
    proxy_pass http://notification-service:7000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}

# ============================
# 14) WEBSOCKET (/CHAT/SOCKET.IO)
# ============================
location /chat/socket.io/ {
    proxy_pass http://communication-service:1000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}

# Catch-all
location /api/ {
    return 404 "API endpoint not found\n";
}


}